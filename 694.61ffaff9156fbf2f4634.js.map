{"version":3,"file":"694.61ffaff9156fbf2f4634.js","mappings":"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","sources":["webpack://micro-app-tianditu-/./src/assets/lib/CarTrack.js"],"sourcesContent":["/* eslint-disable */\n/****\n * 依赖于天地图的D3.js支持库，以SVG的形式对车辆行驶位置及轨迹进行实时跟踪和动态展示。\n * 实现车辆沿路线运动，并有暂停等功能。\n * 注：chrome、safari、IE9及以上浏览器。\n * @author juyang\n * ****/\n\n/**\n * 车辆的图片，包含坐标和旋转相关方法\n */\nvar CarOverlay = T.Overlay.extend({\n  initialize: function (lnglat, options) {\n    this.lnglat = lnglat;\n    this.setOptions(options);\n    this.options = options;\n  },\n\n  onAdd: function (map) {\n    this.map = map;\n    var div = this.div = document.createElement(\"div\");\n    var img = this.img = document.createElement(\"img\");\n    div.style.position = \"absolute\";\n    div.style.width = this.options.width + \"px\";\n    div.style.height = this.options.height + \"px\";\n    div.style.marginLeft = -this.options.width / 2 + 'px';\n    div.style.marginTop = -this.options.height / 2 + 'px';\n    div.style.zIndex = 200;// this._container.style.zIndex = zIndex;\n    img.style.width = this.options.width + \"px\";\n    img.style.height = this.options.height + \"px\";\n    img.src = this.options.iconUrl;\n    div.appendChild(img);\n    map.getPanes().overlayPane.appendChild(this.div);\n    this.update(this.lnglat);\n  },\n\n  onRemove: function () {\n    var parent = this.div.parentNode;\n    if (parent) {\n      parent.removeChild(this.div);\n      this.map = null;\n      this.div = null;\n    }\n  },\n\n  /**\n   * 每个浏览器的偏转兼容\n   * @returns {string}\n   * @constructor\n   */\n  CSS_TRANSFORM: function () {\n    var div = document.createElement('div');\n    var props = [\n      'transform',\n      'WebkitTransform',\n      'MozTransform',\n      'OTransform',\n      'msTransform'\n    ];\n\n    for (var i = 0; i < props.length; i++) {\n      var prop = props[i];\n      if (div.style[prop] !== undefined) {\n        return prop;\n      }\n    }\n    return props[0];\n  },\n\n  /**\n   * 偏转角度\n   * @param rotate\n   */\n  setRotate: function (rotate) {\n    this.img.style[this.CSS_TRANSFORM()] = \"rotate(\" +\n      rotate + \"deg)\";\n  },\n\n  setLnglat: function (lnglat) {\n    this.lnglat = lnglat;\n    this.update();\n  },\n  getLnglat: function () {\n    return this.lnglat;\n  },\n  setPos: function (pos) {\n    this.lnglat = this.map.layerPointToLngLat(pos)\n    this.update();\n  },\n  /**\n   * 更新位置\n   */\n  update: function () {\n    var pos = this.map.lngLatToLayerPoint(this.lnglat);\n    this.div.style.left = pos.x + \"px\";\n    this.div.style.top = pos.y + \"px\";\n  }\n\n\n})\n\nT.CarTrack = function (map, opt) {\n  this.map = map;\n\n  //  this.options = opt ? opt : {};\n  //  this.options= this.setOptions(this.options,opt)\n  //this.options.interval = this.options.interval ? this.options.interval : 1000;\n\n  // this.options.uid = new Date().getTime();\n  // this.uid = this.options.uid\n  this.options.polylinestyle = this.setOptions(this.options.polylinestyle, opt.polylinestyle)\n  this.options.carstyle = this.setOptions(this.options.carstyle, opt.carstyle)\n  this.options = this.setOptions(this.options, opt)\n  this.init();\n\n}\n\nT.CarTrack.prototype = {\n\n  options: {\n\n    interval: 1000,\n    carstyle: {\n      display: true,\n      iconUrl: \"http://lbs.tianditu.gov.cn/images/openlibrary/car.png\",\n      width: 52,\n      height: 26\n    },\n    polylinestyle: {\n      display: true,\n      color: \"red\",\n      width: \"3\",\n      opacity: 0.8,\n      lineStyle: \"\"\n    }\n  },\n\n  init: function () {\n    var datas = this.options.Datas;\n    this.options = this._deepCopy(this.options);\n    this.options.uid = new Date().getTime();\n    this.options.Datas = datas;\n    if (this.options.speed > 0) {\n      var dis = this.distance(this.options.Datas);\n      this.options.nodeslength = dis / this.options.speed;//总步数；\n    }\n    else {\n      this.options.nodeslength = this.options.Datas.length;//总步数；\n    }\n    //计步器\n    this.options.Counter = 0;\n    //new出D3的图层，等待数据\n\n    this.D3OverLayer = new T.D3Overlay(this.d3init, this.d3redraw, this.options);\n    this.D3OverLayer.lineDatas = [];//线数据\n    //共享两个函数\n    this.D3OverLayer.dataToLnglat = this.dataToLnglat;\n    this.D3OverLayer.applyLatLngToLayer = this.applyLatLngToLayer;\n    //this.D3OverLayer.updateSymbolLine = this.updateSymbolLine;\n    //接收，处理数据，加载轨迹和车辆；\n    this.receiveData(this.map);\n  },\n\n  setOptions: function (obj, options) {\n    for (var i in options) {\n      if (i != \"polylinestyle\" && i != \"carstyle\")\n        obj[i] = options[i];\n    }\n    return obj;\n  },\n  /**\n   *  清除所有元素，注销事件\n   */\n  clear: function () {\n    this.state = 4;\n    this._Remove();\n    delete this;\n  },\n\n  _Remove: function () {\n    this._pause();\n    delete this._timer;\n    this._timer = null;\n    this.map.removeOverLay(this.carMarker);\n    this.map.removeOverLay(this.D3OverLayer);\n  },\n\n  /**处理传入的数据**/\n  receiveData: function () {\n    var opt = this.options;\n    var me = this;\n\n    if (opt.Datas instanceof Array && opt.Datas.length > 0) {\n      //绘制出D3渲染的线段；\n      me.map.addOverLay(me.D3OverLayer)\n      //绘制车辆\n      me.carMarker = new CarOverlay(me.dataToLnglat(this.options.Datas[0]), me.options.carstyle);\n      if (!this.options.carstyle)\n        me.carMarker.hide();\n      me.map.addOverLay(this.carMarker);\n\n      me.D3OverLayer.bringToBack();\n    }\n\n  },\n  /**\n   * 坐标获取\n   * @param obj\n   * @returns {T.LngLat}\n   */\n  dataToLnglat: function (obj) {\n    if (obj instanceof T.LngLat || ('lat' in obj && 'lng' in obj))\n      return obj;\n    else {\n      var coordinates = obj.geometry.coordinates;\n      var lnlat = new T.LngLat(coordinates[0], coordinates[1]);\n      return lnlat;\n    }\n  },\n\n  bind: function (fn, obj) {\n    var slice = Array.prototype.slice;\n    if (fn.bind) {\n      return fn.bind.apply(fn, slice.call(arguments, 1));\n    }\n  },\n\n  /**\n   * 坐标转换\n   * @param d\n   * @returns {*}\n   */\n  applyLatLngToLayer: function (d) {\n    return this.map.lngLatToLayerPoint(this.dataToLnglat(d));\n  },\n\n  d3init: function (sel, transform) {\n\n    sel.append(\"path\")\n      .attr(\"id\", \"polyline\" + this.options.uid)\n      .attr(\"fill\", \"none\")\n      .attr(\"stroke\", this.options.polylinestyle.color)\n      .attr(\"width\", this.options.polylinestyle.width)\n      .attr('opacity', this.options.polylinestyle.opacity)\n      .attr('display', this.options.polylinestyle.display ? \"block\" : \"none\")\n\n    sel.append(\"path\")\n      .attr(\"id\", \"dynamicLine\" + this.options.uid)\n      .attr(\"fill\", \"none\")\n      .attr(\"stroke\", this.options.polylinestyle.color)\n      .attr(\"width\", this.options.polylinestyle.width)\n      .attr('opacity', this.options.polylinestyle.opacity)\n      .attr('display', this.options.dynamicLine && this.options.polylinestyle.display ? \"block\" : \"none\")\n\n  },\n\n\n  d3redraw: function () {\n    //像素点坐标转字符串\n    function pointsToPath(rings, closed) {\n      var str = '',\n        i, j, len, len2, points, p;\n\n      for (i = 0, len = rings.length; i < len; i++) {\n        points = rings[i];\n\n        for (j = 0, len2 = points.length; j < len2; j++) {\n          p = points[j];\n          str += (j ? 'L' : 'M') + p.x + ' ' + p.y;\n        }\n\n        // closes the ring for polygons; \"x\" is VML syntax\n        str += closed ? (L.Browser.svg ? 'z' : 'x') : '';\n      }\n\n      // SVG complains about empty path strings\n      return str || 'M0 0';\n    }\n\n    function lnglatsTopoints(map, lnglats) {\n      var pts = [];\n      for (var k = 0; k < lnglats.length; k++) {\n        pts.push(map.lngLatToLayerPoint(lnglats[k]))\n      }\n      return pts;\n    }\n    var datasStr1 = pointsToPath([lnglatsTopoints(this.map, this.options.Datas)], false);//this._svg.\n    var lineDatas = this.lineDatas ? this.lineDatas : this.D3OverLayer.lineDatas;\n    var datasStr2 = pointsToPath([lnglatsTopoints(this.map, lineDatas)], false);//this.options.dynamicLine ? this.lineDatas : this.options.Datas;\n    //线数据的重新计算分两种情况 1、缩放地图时要重新计算容器坐标 2、动态线的时候要重绘线\n    d3.select(\"path#polyline\" + this.options.uid).attr(\"d\", datasStr1)\n      .attr(\"stroke-width\", this.options.polylinestyle.width + \"px\");\n\n    d3.select(\"path#dynamicLine\" + this.options.uid).attr(\"d\", datasStr2)\n      .attr(\"stroke-width\", this.options.polylinestyle.width + \"px\");\n\n\n  },\n\n\n  /**\n   * 随着时间\n   */\n  update: function () {\n    //计步器+1\n    this.options.Counter++\n    var linePath = d3.select('path#polyline' + this.options.uid)\n      .attr('display', this.options.polylinestyle.display && !this.options.dynamicLine ?\n        \"block\" : \"none\")\n    //轨迹像素长度\n    var nodeslength = (this.options.speed > 0 ?\n      Math.ceil(this.options.nodeslength) + 1 :\n      Math.ceil(this.options.nodeslength)\n    )\n\n    if (this.options.speed > 0) {\n      //计算小车所在的像素点\n      var l = linePath.node().getTotalLength();\n      var s = (this.options.Counter - 1) / this.options.nodeslength\n      var l1 = s * l;\n      var p1 = linePath.node().getPointAtLength(l1);\n      this.D3OverLayer.lineDatas = [];\n      if (this.options.Datas[0])\n        this.D3OverLayer.lineDatas.push(this.options.Datas[0]);\n      var lsum = 0;\n      // 计算像素点前的所有包含的轨迹坐标的像素点\n      for (var k = 0; k < this.options.Datas.length - 1; k++) {\n        var p2 = this.map.lngLatToLayerPoint(this.options.Datas[k]);\n        var p3 = this.map.lngLatToLayerPoint(this.options.Datas[k + 1]);\n        var l2 = p2.distanceTo(p3);\n        lsum = lsum + l2;\n        if (l1 > lsum)\n          this.D3OverLayer.lineDatas.push(this.options.Datas[k + 1]);\n        else {\n          break;\n        }\n      }\n      if (this.options.Counter < nodeslength) {\n        var lnglat = this.map.layerPointToLngLat(p1)\n        this.D3OverLayer.lineDatas.push(lnglat);\n      }\n\n    }\n    else {\n      this.D3OverLayer.lineDatas = this.options.Datas.slice(0, this.options.Counter);\n    }\n\n    this.carMarker.setLnglat(this.D3OverLayer.lineDatas[this.D3OverLayer.lineDatas.length - 1]);\n    //车辆偏转角计算。\n    if (this.options.Counter > 1) {\n      var rotate = this.angle(\n        this.D3OverLayer.lineDatas[this.D3OverLayer.lineDatas.length - 2],\n        this.D3OverLayer.lineDatas[this.D3OverLayer.lineDatas.length - 1]);\n      this.carMarker.setRotate(rotate)\n    }\n    else {\n      this.carMarker.setRotate(0)\n    }\n    if (this.options.dynamicLine) this.d3redraw();\n\n    /**回调函数，车辆每移动一次触发的函数\n     *Lnglat：经过的坐标\n     *index：节点序号。\n     *length:总节点数量。\n     ***/\n    if (this.options.passOneNode) this.options.passOneNode(\n      this.carMarker.getLnglat(),\n      this.options.Counter,\n      nodeslength\n    )\n    if (this.options.Counter >= nodeslength) {\n      this.options.Counter = 0;\n    }\n  },\n\n\n  /**\n   * 计算轨迹的距离\n   * @returns {number}\n   */\n  distance: function () {\n    var d = 0;\n    var datas = this.options.Datas;\n    var l = datas.length;\n    for (var i = 0; i < l - 1; i++) {\n      var p1 = this.dataToLnglat(datas[i]);\n      var p2 = this.dataToLnglat(datas[i + 1]);\n      d = d + this.map.getDistance(p1, p2);\n    }\n    return d;\n  },\n\n  /**\n   *在每个点的真实步骤中设置小车转动的角度\n   */\n\n  angle: function (curPos, targetPos) {\n    var deg = 0;\n    if (targetPos.lng != curPos.lng) {\n      var tan = (targetPos.lat - curPos.lat) / (targetPos.lng - curPos.lng),\n        atan = Math.atan(tan);\n      deg = -atan * 360 / (2 * Math.PI);\n      if (targetPos.lng < curPos.lng) {\n        deg = -deg + 90 + 90;\n\n      } else {\n        deg = -deg;\n      }\n      return -deg;\n    } else {\n      var disy = targetPos.lat - curPos.lat;\n      var bias = 0;\n      if (disy > 0)\n        bias = -1\n      else\n        bias = 1\n      return (-bias * 90);\n    }\n    return;\n\n  },\n\n  /**\n   *开始运动\n   */\n  start: function () {\n    if (this.state == 4) return;\n    this.state = 1;\n    if (this.D3OverLayer && !this._timer) {\n      this._timer = setInterval(this.bind(this.update, this),\n        this.options.interval);\n    }\n  },\n\n  /**\n   * 停止运动\n   */\n  stop: function () {\n    if (this.state == 4) return;\n    this.state = 2;\n    this._pause();\n    this._Remove();\n    this.init();\n\n  },\n\n  _pause: function () {\n    if (this._timer) {\n      clearTimeout(this._timer);\n      delete this._timer;\n      this._timer = null;\n    }\n\n    return this;\n  },\n  /**\n   * 暂停运动\n   */\n  pause: function () {\n    if (this.state == 4) return;\n    this.state = 3;\n    this._pause();\n  },\n  _deepCopy: function (source) {\n    var result = {};\n    for (var key in source) {\n      result[key] = typeof source[key] === 'object' ? this._deepCopy(source[key]) : source[key];\n    }\n    return result;\n  }\n}\n"],"names":["CarOverlay","T","Overlay","extend","initialize","lnglat","options","this","setOptions","onAdd","map","div","document","createElement","img","style","position","width","height","marginLeft","marginTop","zIndex","src","iconUrl","appendChild","getPanes","overlayPane","update","onRemove","parent","parentNode","removeChild","CSS_TRANSFORM","props","i","length","prop","undefined","setRotate","rotate","setLnglat","getLnglat","setPos","pos","layerPointToLngLat","lngLatToLayerPoint","left","x","top","y","CarTrack","opt","polylinestyle","carstyle","init","prototype","interval","display","color","opacity","lineStyle","datas","Datas","_deepCopy","uid","Date","getTime","speed","dis","distance","nodeslength","Counter","D3OverLayer","D3Overlay","d3init","d3redraw","lineDatas","dataToLnglat","applyLatLngToLayer","receiveData","obj","clear","state","_Remove","_pause","_timer","removeOverLay","carMarker","me","Array","addOverLay","hide","bringToBack","LngLat","coordinates","geometry","bind","fn","slice","apply","call","arguments","d","sel","transform","append","attr","dynamicLine","pointsToPath","rings","closed","j","len","len2","points","p","str","L","Browser","svg","lnglatsTopoints","lnglats","pts","k","push","datasStr1","datasStr2","d3","select","linePath","Math","ceil","l","node","getTotalLength","l1","p1","getPointAtLength","lsum","p2","p3","distanceTo","angle","passOneNode","getDistance","curPos","targetPos","deg","lng","tan","lat","atan","PI","start","setInterval","stop","clearTimeout","pause","source","result","key"],"sourceRoot":""}