(self.webpackChunkmicro_app_tianditu_=self.webpackChunkmicro_app_tianditu_||[]).push([[694],{694:()=>{var t=T.Overlay.extend({initialize:function(t,i){this.lnglat=t,this.setOptions(i),this.options=i},onAdd:function(t){this.map=t;var i=this.div=document.createElement("div"),s=this.img=document.createElement("img");i.style.position="absolute",i.style.width=this.options.width+"px",i.style.height=this.options.height+"px",i.style.marginLeft=-this.options.width/2+"px",i.style.marginTop=-this.options.height/2+"px",i.style.zIndex=200,s.style.width=this.options.width+"px",s.style.height=this.options.height+"px",s.src=this.options.iconUrl,i.appendChild(s),t.getPanes().overlayPane.appendChild(this.div),this.update(this.lnglat)},onRemove:function(){var t=this.div.parentNode;t&&(t.removeChild(this.div),this.map=null,this.div=null)},CSS_TRANSFORM:function(){for(var t=document.createElement("div"),i=["transform","WebkitTransform","MozTransform","OTransform","msTransform"],s=0;s<i.length;s++){var e=i[s];if(void 0!==t.style[e])return e}return i[0]},setRotate:function(t){this.img.style[this.CSS_TRANSFORM()]="rotate("+t+"deg)"},setLnglat:function(t){this.lnglat=t,this.update()},getLnglat:function(){return this.lnglat},setPos:function(t){this.lnglat=this.map.layerPointToLngLat(t),this.update()},update:function(){var t=this.map.lngLatToLayerPoint(this.lnglat);this.div.style.left=t.x+"px",this.div.style.top=t.y+"px"}});T.CarTrack=function(t,i){this.map=t,this.options.polylinestyle=this.setOptions(this.options.polylinestyle,i.polylinestyle),this.options.carstyle=this.setOptions(this.options.carstyle,i.carstyle),this.options=this.setOptions(this.options,i),this.init()},T.CarTrack.prototype={options:{interval:1e3,carstyle:{display:!0,iconUrl:"http://lbs.tianditu.gov.cn/images/openlibrary/car.png",width:52,height:26},polylinestyle:{display:!0,color:"red",width:"3",opacity:.8,lineStyle:""}},init:function(){var t=this.options.Datas;if(this.options=this._deepCopy(this.options),this.options.uid=(new Date).getTime(),this.options.Datas=t,this.options.speed>0){var i=this.distance(this.options.Datas);this.options.nodeslength=i/this.options.speed}else this.options.nodeslength=this.options.Datas.length;this.options.Counter=0,this.D3OverLayer=new T.D3Overlay(this.d3init,this.d3redraw,this.options),this.D3OverLayer.lineDatas=[],this.D3OverLayer.dataToLnglat=this.dataToLnglat,this.D3OverLayer.applyLatLngToLayer=this.applyLatLngToLayer,this.receiveData(this.map)},setOptions:function(t,i){for(var s in i)"polylinestyle"!=s&&"carstyle"!=s&&(t[s]=i[s]);return t},clear:function(){this.state=4,this._Remove()},_Remove:function(){this._pause(),delete this._timer,this._timer=null,this.map.removeOverLay(this.carMarker),this.map.removeOverLay(this.D3OverLayer)},receiveData:function(){var i=this.options,s=this;i.Datas instanceof Array&&i.Datas.length>0&&(s.map.addOverLay(s.D3OverLayer),s.carMarker=new t(s.dataToLnglat(this.options.Datas[0]),s.options.carstyle),this.options.carstyle||s.carMarker.hide(),s.map.addOverLay(this.carMarker),s.D3OverLayer.bringToBack())},dataToLnglat:function(t){if(t instanceof T.LngLat||"lat"in t&&"lng"in t)return t;var i=t.geometry.coordinates;return new T.LngLat(i[0],i[1])},bind:function(t,i){var s=Array.prototype.slice;if(t.bind)return t.bind.apply(t,s.call(arguments,1))},applyLatLngToLayer:function(t){return this.map.lngLatToLayerPoint(this.dataToLnglat(t))},d3init:function(t,i){t.append("path").attr("id","polyline"+this.options.uid).attr("fill","none").attr("stroke",this.options.polylinestyle.color).attr("width",this.options.polylinestyle.width).attr("opacity",this.options.polylinestyle.opacity).attr("display",this.options.polylinestyle.display?"block":"none"),t.append("path").attr("id","dynamicLine"+this.options.uid).attr("fill","none").attr("stroke",this.options.polylinestyle.color).attr("width",this.options.polylinestyle.width).attr("opacity",this.options.polylinestyle.opacity).attr("display",this.options.dynamicLine&&this.options.polylinestyle.display?"block":"none")},d3redraw:function(){function t(t,i){var s,e,n,a,o,r,h="";for(s=0,n=t.length;s<n;s++){for(e=0,a=(o=t[s]).length;e<a;e++)h+=(e?"L":"M")+(r=o[e]).x+" "+r.y;h+=i?L.Browser.svg?"z":"x":""}return h||"M0 0"}function i(t,i){for(var s=[],e=0;e<i.length;e++)s.push(t.lngLatToLayerPoint(i[e]));return s}var s=t([i(this.map,this.options.Datas)],!1),e=this.lineDatas?this.lineDatas:this.D3OverLayer.lineDatas,n=t([i(this.map,e)],!1);d3.select("path#polyline"+this.options.uid).attr("d",s).attr("stroke-width",this.options.polylinestyle.width+"px"),d3.select("path#dynamicLine"+this.options.uid).attr("d",n).attr("stroke-width",this.options.polylinestyle.width+"px")},update:function(){this.options.Counter++;var t=d3.select("path#polyline"+this.options.uid).attr("display",this.options.polylinestyle.display&&!this.options.dynamicLine?"block":"none"),i=this.options.speed>0?Math.ceil(this.options.nodeslength)+1:Math.ceil(this.options.nodeslength);if(this.options.speed>0){var s=t.node().getTotalLength(),e=(this.options.Counter-1)/this.options.nodeslength*s,n=t.node().getPointAtLength(e);this.D3OverLayer.lineDatas=[],this.options.Datas[0]&&this.D3OverLayer.lineDatas.push(this.options.Datas[0]);for(var a=0,o=0;o<this.options.Datas.length-1;o++){var r=this.map.lngLatToLayerPoint(this.options.Datas[o]),h=this.map.lngLatToLayerPoint(this.options.Datas[o+1]);if(!(e>(a+=r.distanceTo(h))))break;this.D3OverLayer.lineDatas.push(this.options.Datas[o+1])}if(this.options.Counter<i){var l=this.map.layerPointToLngLat(n);this.D3OverLayer.lineDatas.push(l)}}else this.D3OverLayer.lineDatas=this.options.Datas.slice(0,this.options.Counter);if(this.carMarker.setLnglat(this.D3OverLayer.lineDatas[this.D3OverLayer.lineDatas.length-1]),this.options.Counter>1){var p=this.angle(this.D3OverLayer.lineDatas[this.D3OverLayer.lineDatas.length-2],this.D3OverLayer.lineDatas[this.D3OverLayer.lineDatas.length-1]);this.carMarker.setRotate(p)}else this.carMarker.setRotate(0);this.options.dynamicLine&&this.d3redraw(),this.options.passOneNode&&this.options.passOneNode(this.carMarker.getLnglat(),this.options.Counter,i),this.options.Counter>=i&&(this.options.Counter=0)},distance:function(){for(var t=0,i=this.options.Datas,s=i.length,e=0;e<s-1;e++){var n=this.dataToLnglat(i[e]),a=this.dataToLnglat(i[e+1]);t+=this.map.getDistance(n,a)}return t},angle:function(t,i){var s=0;if(i.lng!=t.lng){var e=(i.lat-t.lat)/(i.lng-t.lng);return s=360*-Math.atan(e)/(2*Math.PI),-(s=i.lng<t.lng?90-s+90:-s)}return 90*-(i.lat-t.lat>0?-1:1)},start:function(){4!=this.state&&(this.state=1,this.D3OverLayer&&!this._timer&&(this._timer=setInterval(this.bind(this.update,this),this.options.interval)))},stop:function(){4!=this.state&&(this.state=2,this._pause(),this._Remove(),this.init())},_pause:function(){return this._timer&&(clearTimeout(this._timer),delete this._timer,this._timer=null),this},pause:function(){4!=this.state&&(this.state=3,this._pause())},_deepCopy:function(t){var i={};for(var s in t)i[s]="object"==typeof t[s]?this._deepCopy(t[s]):t[s];return i}}}}]);